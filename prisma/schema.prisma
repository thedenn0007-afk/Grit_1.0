generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER MODEL (with NextAuth)
// ===========================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  
  // NextAuth Relations
  accounts      Account[]
  sessions      Session[]
  
  // App Relations
  progress      UserProgress[]
  attempts      Attempt[]

  @@map("USER")
}

// ===========================================
// NEXTAUTH MODELS
// ===========================================
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_at        Int?    @map("expires_at")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("ACCOUNT")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("SESSION")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("VERIFICATION_TOKEN")
}

// ===========================================
// TOPIC MODEL
// ===========================================
model Topic {
  id          String     @id @default(cuid())
  title       String
  description String
  orderIndex  Int        @map("order_index")
  status      String     @default("locked") // locked, available, completed
  
  // Relations
  subtopics   Subtopic[]

  @@map("TOPIC")
}

// ===========================================
// SUBTOPIC MODEL
// ===========================================
model Subtopic {
  id               String   @id @default(cuid())
  topicId          String   @map("topic_id")
  title            String
  complexityScore  Int      @map("complexity_score")
  contentJson      String   @map("content_json")
  estimatedMinutes Int      @map("estimated_minutes")
  status           String   @default("locked") // locked, available, in_progress, completed
  
  // Relations
  topic            Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  progress         UserProgress[]
  attempts         Attempt[]

  @@map("SUBTOPIC")
}

// ===========================================
// USER PROGRESS MODEL
// ===========================================
model UserProgress {
  userId        String    @map("user_id")
  subtopicId    String    @map("subtopic_id")
  status        String    @default("not_started") // not_started, in_progress, completed
  currentPhase  String    @map("current_phase") // content, checkpoint, results, deep_dive
  exitPointJson String?   @map("exit_point_json")
  coreMastery   Float     @default(0.0) @map("core_mastery")
  completedAt   DateTime? @map("completed_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subtopic      Subtopic  @relation(fields: [subtopicId], references: [id], onDelete: Cascade)

  @@id([userId, subtopicId])
  @@map("USER_PROGRESS")
}

// ===========================================
// ATTEMPT MODEL
// ===========================================
model Attempt {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  subtopicId      String   @map("subtopic_id")
  questionsJson   String   @map("questions_json")
  answersJson     String   @map("answers_json")
  scoresJson      String   @map("scores_json")
  totalScore      Int      @map("total_score")
  timeSpentSeconds Int     @map("time_spent_seconds")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subtopic        Subtopic @relation(fields: [subtopicId], references: [id], onDelete: Cascade)

  @@map("ATTEMPT")
}
